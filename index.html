<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lot Size Calculator</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #0f172a;
  color: #e5e7eb;
  padding: 20px;
}

.box {
  max-width: 420px;
  margin: auto;
  background: #020617;
  padding: 20px;
  border-radius: 10px;
}

h2 {
  text-align: center;
  margin-bottom: 15px;
}

label {
  display: block;
  margin-top: 10px;
  font-size: 14px;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-top: 5px;
  border-radius: 6px;
  border: none;
  font-size: 16px;
}

.toggle {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 15px;
  padding: 10px;
  background: #020617;
  border: 1px solid #1e293b;
  border-radius: 8px;
}

button {
  margin-top: 20px;
  width: 100%;
  padding: 12px;
  font-size: 16px;
  background: #22c55e;
  color: #022c22;
  border: none;
  border-radius: 8px;
}

.result {
  margin-top: 15px;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
}

/* Journal table */
.table-wrap {
  overflow-x: auto;
}

table {
  min-width: 900px;
  border-collapse: collapse;
  font-size: 14px;
}

td, th {
  white-space: nowrap;
  padding: 6px;
  border: 1px solid #1e293b;
  vertical-align: top;
}

.pnl-input {
  width: 80px;
  font-weight: bold;
}

textarea {
  min-width: 160px;
  min-height: 60px;
  resize: vertical;
  padding: 6px;
  border-radius: 6px;
  border: none;
  font-size: 14px;
}
</style>
</head>

<body>

<div style="text-align:center; margin-bottom:15px;">
  <button onclick="showCalculator()">Calculator</button>
  <button onclick="showJournal()">Journal</button>
</div>

<!-- CALCULATOR -->
<div class="box" id="calculatorPage">
<h2>Lot Size Calculator</h2>

<label>Asset</label>
<select id="asset">
  <option value="1">NASDAQ (USTECm)</option>
  <option value="1">S&P 500 (US500m)</option>
  <option value="1">US30 (US30m)</option>
  <option value="100">Gold (XAUUSDm)</option>
  <option value="5000">Silver (XAGUSDm)</option>
  <option value="1">BTCUSD</option>
  <option value="1">ETHUSD</option>
  <option value="1">SOLUSD</option>
</select>

<label>Entry Price</label>
<input type="number" id="entry">

<label>Stop Loss Price</label>
<input type="number" id="stop">

<div class="toggle">
  <span>Use Account Size & Risk %</span>
  <input type="checkbox" id="riskMode" onchange="toggleRiskMode()">
</div>

<div id="manualRisk">
  <label>Risk Amount ($)</label>
  <input type="number" id="riskAmount">
</div>

<div id="percentRisk" style="display:none;">
  <label>Account Balance</label>
  <input type="number" id="accountSize">
  <label>Risk %</label>
  <input type="number" id="riskPercent">
</div>

<button onclick="calculate()">Calculate Lot Size</button>
<div class="result" id="result"></div>
</div>

<!-- JOURNAL -->
<div class="box" id="journalPage" style="display:none;">
<h2>Trade Journal</h2>

<label>Select Month</label>
<select id="monthSelect" onchange="changeMonth(this.value)"></select>

<div id="statsBox" style="margin:10px 0; padding:10px; border:1px solid #1e293b; border-radius:8px;"></div>

<div class="table-wrap">
<table>
<thead>
<tr>
<th>Date</th><th>Asset</th><th>Risk</th><th>Lot</th>
<th>Result</th><th>PnL ($)</th><th>Notes</th><th>❌</th>
</tr>
</thead>
<tbody id="journalBody"></tbody>
</table>
</div>
</div>

<script>
let activeMonth = new Date().toISOString().slice(0,7);

/* ---------- NAV ---------- */
function toggleRiskMode() {
  manualRisk.style.display = riskMode.checked ? "none" : "block";
  percentRisk.style.display = riskMode.checked ? "block" : "none";
}

function showCalculator() {
  calculatorPage.style.display = "block";
  journalPage.style.display = "none";
}

function showJournal() {
  calculatorPage.style.display = "none";
  journalPage.style.display = "block";
  loadMonthOptions();
  loadJournal();
}

/* ---------- CALCULATOR ---------- */
function calculate() {
  const entry = Number(entryInput.value);
  const stop = Number(stopInput.value);
  const vpp = Number(asset.value);

  if (!entry || !stop) {
    result.innerText = "Enter entry & stop";
    return;
  }

  const dist = Math.abs(entry - stop);
  if (dist === 0) {
    result.innerText = "Stop distance cannot be zero";
    return;
  }

  let risk;
  if (riskMode.checked) {
    risk = Number(accountSize.value) * (Number(riskPercent.value) / 100);
  } else {
    risk = Number(riskAmount.value);
  }

  if (!risk || risk <= 0) {
    result.innerText = "Enter valid risk";
    return;
  }

  const lot = risk / (dist * vpp);
  result.innerText = "Lot Size: " + lot.toFixed(2);

  saveTrade(risk, lot);
}

/* ---------- STORAGE ---------- */
function saveTrade(risk, lot) {
  const j = JSON.parse(localStorage.tradingJournal || "{}");
  if (!j[activeMonth]) j[activeMonth] = [];

  j[activeMonth].push({
    date: new Date().toISOString().slice(0,10),
    asset: asset.options[asset.selectedIndex].text,
    risk,
    lot,
    result: "OPEN",
    pnl: null,
    notes: ""
  });

  localStorage.tradingJournal = JSON.stringify(j);
}

/* ---------- JOURNAL ---------- */
function loadJournal() {
  const j = JSON.parse(localStorage.tradingJournal || "{}");
  const t = j[activeMonth] || [];
  journalBody.innerHTML = "";

  t.forEach((x,i)=>{
    journalBody.innerHTML += `
<tr>
<td>${x.date}</td>
<td>${x.asset}</td>
<td>$${x.risk}</td>
<td>${x.lot.toFixed(2)}</td>
<td>
<select onchange="update(${i},'result',this.value);loadJournal()">
<option ${x.result==="OPEN"?"selected":""}>OPEN</option>
<option ${x.result==="WIN"?"selected":""}>WIN</option>
<option ${x.result==="LOSS"?"selected":""}>LOSS</option>
<option ${x.result==="BE"?"selected":""}>BE</option>
</select>
</td>
<td>
<input class="pnl-input" type="number"
value="${x.pnl === null ? "" : Math.abs(x.pnl)}"
onchange="update(${i},'pnl',this.value);loadJournal()">
<span>${x.pnl === null ? "" : x.pnl > 0 ? `+${x.pnl}` : `${x.pnl}`}</span>
</td>
<td>
<textarea onchange="update(${i},'notes',this.value)">${x.notes}</textarea>
</td>
<td><button onclick="del(${i})">❌</button></td>
</tr>`;
  });

  calcStats();
}

function update(i, field, value) {
  const j = JSON.parse(localStorage.tradingJournal || "{}");
  const trade = j[activeMonth][i];

  if (field === "pnl") {
    if (value === "") {
      trade.pnl = null;
    } else {
      const abs = Math.abs(Number(value));
      if (trade.result === "LOSS") trade.pnl = -abs;
      else if (trade.result === "WIN") trade.pnl = abs;
      else trade.pnl = 0;
    }
  }
  else if (field === "result") {
    trade.result = value;
    if (trade.pnl !== null) {
      const abs = Math.abs(trade.pnl);
      if (value === "LOSS") trade.pnl = -abs;
      else if (value === "WIN") trade.pnl = abs;
      else trade.pnl = 0;
    }
  }
  else {
    trade[field] = value;
  }

  localStorage.tradingJournal = JSON.stringify(j);
}

function del(i) {
  if (!confirm("Delete trade?")) return;
  const j = JSON.parse(localStorage.tradingJournal || "{}");
  j[activeMonth].splice(i,1);
  localStorage.tradingJournal = JSON.stringify(j);
  loadJournal();
}

/* ---------- MONTHS & STATS ---------- */
function loadMonthOptions() {
  const j = JSON.parse(localStorage.tradingJournal || "{}");
  monthSelect.innerHTML = "";
  Object.keys(j).sort().reverse().forEach(m=>{
    monthSelect.innerHTML += `<option ${m===activeMonth?"selected":""}>${m}</option>`;
  });
}

function changeMonth(m) {
  activeMonth = m;
  loadJournal();
}

function calcStats() {
  const j = JSON.parse(localStorage.tradingJournal || "{}");
  const t = j[activeMonth] || [];

  let w=0,l=0,b=0,p=0;
  t.forEach(x=>{
    if(x.result==="WIN") w++;
    if(x.result==="LOSS") l++;
    if(x.result==="BE") b++;
    p += x.pnl || 0;
  });

  const wr = (w+l) ? ((w/(w+l))*100).toFixed(1) : "0.0";

  statsBox.innerHTML = `
Trades: ${t.length}<br>
Wins: ${w} | Losses: ${l} | BE: ${b}<br>
Win Rate: ${wr}%<br>
Net PnL: $${p.toFixed(2)}
`;
}

/* ---------- DOM REFS ---------- */
const entryInput = document.getElementById("entry");
const stopInput = document.getElementById("stop");
</script>

</body>
</html>